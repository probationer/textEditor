<!DOCTYPE html>
<html>
    <head>
        <title id="title">
            Writer Box
        </title>
        <link rel="stylesheet" type="text/css" href="../bower_components/bootstrap/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="css/left_panel.css">
        <link rel="stylesheet" href="css/right-panel.css">
        <link rel="stylesheet" href="css/middle-panel.css">
        <link rel="stylesheet" href="css/saved_file_text.css">
        <link rel="stylesheet" href="css/footer.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src="../editor/tinymce/js/tinymce/jquery.tinymce.min.js"></script>
        <script src="../editor/tinymce/js/tinymce/tinymce.min.js"></script>
        <script src="../editor/tinymce/js/tinymce/tiny_mce.js"></script>
        <script src="../bower_components/jquery/dist/jquery.min.js"></script>

        <script>
            tinymce.init({
                selector: 'textarea#textarea_file',
                theme: 'modern',
                // inline: true,
                // hidden_input: false,
                autosave_interval: "20s",
                plugins: 'preview searchreplace autosave directionality visualblocks visualchars fullscreen link table charmap hr anchor toc insertdatetime advlist lists textcolor wordcount contextmenu colorpicker textpattern',
                toolbar1: 'formatselect | font |bold italic strikethrough superscript subscript codesample | link | alignleft aligncenter alignright alignjustify  | numlist bullist | removeformat',
            });
        </script>

    </head>

    <body>
        <div class="left-panel" id="leftPanel">
            <div class="product-desc">
                <img src="images/product-logo.png">
                <div class="product-name">writer box</div>
            </div>
            <div class="folder-options">
                <div class="option-item main-option">
                    <i class="fa fa-folder large-icon" aria-hidden="true"></i>
                    <a href="" class="option-name">Open Folder</a>
                </div>
                <div class="option-item">
                    <i class="fa fa-file-text-o small-icon" aria-hidden="true"></i>
                    <a href="" class="option-name">File 1</a>
                </div>
                <div class="option-item">
                    <i class="fa fa-file-text-o small-icon" aria-hidden="true"></i>
                    <a href="" class="option-name">File 2</a>
                </div>
                <div class="option-item">
                    <i class="fa fa-file-text-o small-icon" aria-hidden="true"></i>
                    <a href="" class="option-name">File 3</a>
                </div>
            </div>

        </div>
        <div id="middle_section" >
            <div class="header-container">
                <input id="file_name" placeholder="Document Title">
                <div id="saved_file_notification" class="saved_file_notification" style=" margin: 50px 0px 0px 40px;">All Changes are saved</div>
                <div class="button-container">
                    <button type="button" class="save-button" onclick="alert('Hello world!')">Merge Changes</button>
                    <button type="button" class="save-button" onclick="alert('Hello world!')">
                        <i class="fa fa-lock small-icon" aria-hidden="true"></i>
                        <span>Protector</span>
                    </button>
                </div>
            </div>
            <div class="text-editor-container">
                <textarea id="textarea_file" autofocus rows="40"> 
                </textarea>
                <div class="history-writer">
                    <div class="change-header">
                        <i class="fa fa-clock-o clock-icon" aria-hidden="true"></i>
                        <span class="margin-left"> Change Activities</span>
                    </div>
                    <div class="change-items">
                        <div class="change-item-heading">Draft 1: Abc 1</div>
                        <div class="change-item-sub">12:18 a.m, 03-05-2019</div>
                        <div class="change-item-editor">
                            <div class="saved-by">
                                Saved by: <span id="editor-name">Abc</span>
                            </div>
                        </div>
                    </div>
                    <div class="change-items">
                        <div class="change-item-heading">Draft 2: Abc 2</div>
                        <div class="change-item-sub">12:18 a.m, 03-05-2019</div>
                        <div class="change-item-editor">
                            <div class="saved-by">
                                Saved by: <span id="editor-name">Abc</span>
                            </div>
                        </div>
                    </div>
                    <div class="change-items">
                        <div class="change-item-heading">Draft 3: Abc 3</div>
                        <div class="change-item-sub">12:18 a.m, 03-05-2019</div>
                        <div class="change-item-editor">
                            <div class="saved-by">
                                Saved by: <span id="editor-name">Abc</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>    
        const {ipcRenderer} = require('electron');
        const {globalShortcut,app,dialog} = require('electron').remote;
        const fs = require("fs")
        const ps = require("python-shell")
        
        //check file name must not be empty
        function required_input(div_id){
            InputValue = document.getElementById(div_id).value
            if (InputValue.trim() == ""){
                var responseValue;
                option = {
                    type: "info",
                    buttons: ["Okay",],
                    title: "Title of file",
                    message: "I think this beautifull creation must deserve a name",
                }
                responseValue = dialog.showMessageBox(null, option, function(response) {
                                    return response
                                }())
                return responseValue;
                // document.getElementById(div_id).value = NewInputValue
            } 
        }

        //save the file in system
        function saveFile(){
            if (required_input("file_name") != 0){
                tinymce.activeEditor.save();
                // tinymce.triggerSave();
                let item = document.getElementById('textarea_file').value;
                let filename = document.getElementById('file_name').value;
                // TODO: add project dir from frontend 
                //let project_dir = '/Users/vs/Documents/workspace@roy/text-editor/textEditor/text_files/'//documet.getElementById('current_project').value;
                ipcRenderer.send('item_add', [item, filename.split(".")[0]]);
                return true
            }else{
                document.getElementById("file_name").focus();
            }
            return false
        }

        //get reply from main.js
        function reply_from_main(){
            ipcRenderer.on('reply', function(event, arg) {
                // document.getElementById('saved_file_notification').innerHTML = arg;
                document.getElementById('saved_file_notification').classList.add('onSave');
                setTimeout(() => {
                    document.getElementById('saved_file_notification').classList.remove('onSave');
                }, 1500);
                var filename = arg
                filename = filename.split('/').pop()
                console.log(filename)
                document.getElementById('file_name').value = filename;
                savePath(arg)
                add_file_in_context(arg, "leftPanel")
            })
        }

        //add file name in context
        function add_file_in_context(file_name, context_menu_id){
            console.log(file_name, context_menu_id)
            let open_filles = document.getElementById(context_menu_id).innerHTML
            no_file_of_same_name = true
            for(i = 0; i<document.getElementsByTagName("a").length; i++){
                console.log(document.getElementsByTagName("a")[i].innerHTML)
                if(file_name == document.getElementsByTagName("a")[i].innerHTML){
                    console.log('same file name')
                    document.getElementsByTagName("a")[i].style.background = "#464242"
                    no_file_of_same_name = false
                }else{
                    console.log('not same file name', document.getElementsByTagName("a")[i].innerHTML)
                    document.getElementsByTagName("a")[i].style.backgroundColor = getComputedStyle(document.querySelector('.left_panel')).backgroundColor
                }
            }
            if(no_file_of_same_name){
                document.getElementById("current_file").value = file_name
                document.getElementById(context_menu_id).innerHTML = open_filles + '<a href="">'+file_name.split('/').pop()+'</a>';
                document.getElementsByTagName("a")[i].style.background = "#464242"
            }
        }

        //show changes 
        function showChanges(div_id){
            if(document.getElementById(div_id).classList[1] == 'btn-info'){
                document.getElementById(div_id).innerHTML = 'Hide Changes'
                document.getElementById(div_id).classList.remove('btn-info')
                document.getElementById(div_id).classList.add('btn-default')
                document.getElementById(div_id).value =1
                getDiff()
            }else{
                document.getElementById(div_id).innerHTML = 'Show Changes'
                document.getElementById(div_id).classList.remove('btn-default')
                document.getElementById(div_id).classList.add('btn-info')
                document.getElementById(div_id).value =0
            }
            //python get changes
           
            // py.on('message', function (message) {
            //     // received a message sent from the Python script (a simple "print" statement)
            //     // console.log((message))
            //     let doc = new DOMParser().parseFromString(message, 'text/html');
            //     // console.log("DOC", doc.body.childNodes);
            //     // document.getElementById('output_value').appendChild(doc.body.firstChild)
            //     // tinymce.activeEditor.setContent()
            // });
        }
        
        //get difference
        function getDiff(){
            file_path = document.getElementById('current_file').value;
            options = { 
                        mode: 'text',
                        //pythonPath: 'path/to/python',
                        pythonOptions: ['-u'], // get print results in real-time
                        scriptPath: '/Users/vs/Documents/workspace@roy/text-editor/textEditor/backend',
                        args: [file_path,] 
                }
            var py = ps.PythonShell.run("difference_checker.py", options, function(err, results){

                if (err) {
                    console.log(err)
                }else{
                    console.log(results)
                    var data = new String();
                    const doc = new DOMParser()
                    results.forEach(element => {
                        const node = doc.parseFromString(element, 'text/html');
                        if (node.body.firstChild != null && (node.body.firstChild.nodeType > 0 && node.body.firstChild.nodeType <=12 )){
                            // document.getElementById('output_value').appendChild(node.body.firstChild)
                            data += element
                        }
                    })
                    console.log(data)
                    //set data in editor
                    tinymce.activeEditor.insertContent(data)
                }   
            }) 
        }
        
        //save path
        function savePath(file_path){
            options = {
                scriptPath : '/Users/vs/Documents/workspace@roy/text-editor/textEditor/backend',
                args : ['/Users/vs/Documents/workspace@roy/text-editor/textEditor/text_files/.meta/',file_path]
            }
            var py = ps.PythonShell.run("path_manager.py", options, function(err, results){
                if (err) {
                    console.log(err)
                }else{
                    console.log(results)
                }
            })

        }

        //show changes
        function check_showChange_status(){
            const activity = document.getElementById('show_changes').value
            if (activity == '1'){
                // getDiff()
                if (tinymce.activeEditor.isDirty())
                ///setDirty(state:Boolean)
                    alert("You must save your contents.");
            }
        }
        
        //save file
        globalShortcut.register('CommandOrControl+S', () => {
            saveFile()
            reply_from_main()
        })
        
        //read file from system
        globalShortcut.register('CommandOrControl+O', (event) =>{
            dialog.showOpenDialog((filename) => {
                // fileNames is an array that contains all the selected
                if(filename === undefined){
                    console.log("No file selected")
                }
                filepath = filename[0]
                var filedata
                fs.readFile(filepath, 'utf-8', (err, data) => {
                    if(err){
                        console.log("An error ocurred reading the file : " + err.message)
                    }
                    file_name = filepath.split('/').pop()
                    document.getElementById('file_name').value = file_name
                    tinymce.activeEditor.setContent(data)
                    add_file_in_context(filename[0], "leftPanel")
                })
            })
        })
    
        //create new file
        globalShortcut.register('CommandOrControl+N', (event) => {
            if(saveFile()){
                reply_from_main()
                //remove every thing from editor 
                //remove the file name
                document.getElementById('file_name').value = null
                tinymce.activeEditor.setContent();

            }

        })
    
    </script>

    <!-- <footer class="footer">
        <h3>Creation Of S.Roy</h3>
    </footer> -->
</html>
